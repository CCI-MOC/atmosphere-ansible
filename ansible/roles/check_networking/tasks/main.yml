--- 
# TODO NOTE: when moving to ansible 2.0 we should use ansible_host, ansible_port, and ansible_user
- name: verify that host is reachable via ssh port
  local_action:
    module: wait_for
      search_regex=OpenSSH
      port={{ ansible_port }}
      host="{{ inventory_hostname }}"
      delay=1
      timeout={{ SSH_PORT_TIMEOUT }}
  tags: verify-ssh

- name: test default ansible connection
  local_action: "shell ssh -p {{ ansible_port }} root@{{ inventory_hostname }} 'echo hello' | grep 'hello'"
  register: default_remote_user
  ignore_errors: yes
  failed_when: False
  async: "{{ SSH_TIMEOUT }}"
  poll: 1

###
# CENTOS SETUP
###
- name: test centos connection
  local_action: "shell ssh -p {{ ansible_port }} centos@{{ inventory_hostname }} 'echo hello' | grep 'hello'"
  register: centos_remote_user
  ignore_errors: yes
  when: default_remote_user|failed
  failed_when: False
  async: "{{ SSH_TIMEOUT }}"
  poll: 1

###
# UBUNTU SETUP
###
- name: test ubuntu connection
  local_action: "shell ssh -p {{ ansible_port }} ubuntu@{{ inventory_hostname }} 'echo hello' | grep 'hello'"
  register: ubuntu_remote_user
  ignore_errors: yes
  when: default_remote_user|failed and centos_remote_user|failed
  failed_when: False
  async: "{{ SSH_TIMEOUT }}"
  poll: 1

#- debug: var=default_remote_user
#- debug: var=centos_remote_user
#- debug: var=ubuntu_remote_user

#- name: Debug all output last.
#  debug: msg="host={{ansible_host}} root={{default_remote_user.stdout}} centos={{centos_remote_user.stdout}} ubuntu={{ubuntu_remote_user.stdout}}"

#- name: Debug all error last.
#  debug: msg="host={{ansible_host}} root={{default_remote_user.stderr}} centos={{centos_remote_user.stderr}} ubuntu={{ubuntu_remote_user.stderr}}"

- name: fail when ssh not possible
  fail: msg="The host is not reachable via SSH as root and cloud users."
  when: (default_remote_user.stdout is defined and default_remote_user.stdout != "hello") and
        (centos_remote_user.stdout is defined and centos_remote_user.stdout != "hello") and
        (ubuntu_remote_user.stdout is defined and ubuntu_remote_user.stdout != "hello")
